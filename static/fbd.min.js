
/* Copyright (C) 2017 under GPLv3
 * Andrew Janke, Dennis Chang, Lious Boehm, Adithya Ramanathan
 * Readable source code available at --- */
"use strict";function KeyboardAdapter(){assert_new.check(this);var m_keys_down={};this.update_cursor=function(cursor,et){var x_dir=0;var y_dir=0;if(37 in m_keys_down){x_dir=-1;}else if(39 in m_keys_down){x_dir=1;}if(38 in m_keys_down){y_dir=-1;}else if(40 in m_keys_down){y_dir=1;}if(x_dir!==0&&y_dir!==0){x_dir/=Math.sqrt(2);y_dir/=Math.sqrt(2);}cursor.move_in_direction({x:x_dir,y:y_dir});}this.update_key_press=function(keycode){m_keys_down[keycode]=true;}this.update_key_release=function(keycode){delete m_keys_down[keycode];}}function MouseAdapter(){assert_new.check(this);var m_mouse_location=zero_vect();var m_mouse_pressed=false;this.update_location=function(loc){m_mouse_location=loc;}this.update_cursor=function(cursor,et){cursor.set_pressed(m_mouse_pressed);cursor.set_location(m_mouse_location);}this.mouse_click=function(pressed){m_mouse_pressed=pressed;}}function JsonAdapter(){assert_new.check(this);var m_direction=zero_vect();var m_click=false;this.read_json=function(obj){if(obj===undefined)return;if(obj.x!==undefined)m_direction.x=obj.x;if(obj.y!==undefined)m_direction.y=obj.y;if(obj.click_held!==undefined)m_click=obj.click_held;}this.update_cursor=function(cursor,et){cursor.set_pressed(m_click);cursor.move_in_direction(m_direction);}}function App(){assert_new.check(this);var m_context;var m_canvas;var m_time_then=Date.now();var m_keyboard_controller=new KeyboardAdapter();var m_mouse_controller=new MouseAdapter();var m_json_controller=undefined;var m_controllers=[m_keyboard_controller,m_mouse_controller];var m_cursor=new Controller();var m_model=new Model(m_cursor);var m_json_target;var m_update_counter=0;var m_pause=false;function run(){var now=Date.now();var delta=now-m_time_then;if(!m_pause){update(delta/1000);render();}m_time_then=now;}function update(et){m_controllers.forEach(function(controller){controller.update_cursor(m_cursor,et);});m_cursor.do_time_based_updates(et);}function render(){m_context.fillStyle="#FFF";m_context.fillRect(0,0,m_canvas.width,m_canvas.height);m_model.render_to(m_context);}function listen(){if(m_json_target===undefined)return;$.ajax({type:"GET",url:m_json_target,success:function(data){m_json_controller.read_json(data);run();},error:function(XMLHttpRequest,textStatus,errorThrown){},dataType:"json"});setTimeout(listen,50);}this.set_canvas_and_run=function(html_id_str){m_canvas=document.getElementById(html_id_str);m_context=m_canvas.getContext("2d",{alpha:false,depth:false});m_context.scale(1,1);setTimeout(listen,50);run();};this.key_press=function(code){m_keyboard_controller.update_key_press(code);run();};this.key_release=function(code){m_keyboard_controller.update_key_release(code);run();};this.mouse_move=function(loc){m_mouse_controller.update_location(loc);run();}this.mouse_click=function(){m_mouse_controller.mouse_click(true);run();}this.mouse_release=function(){m_mouse_controller.mouse_click(false);run();}this.set_listen_target=function(target_address){m_json_target=target_address;m_json_controller=new JsonAdapter();m_controllers.push(m_json_controller);}this.pause_execution=function(){m_pause=true;}this.resume_execution=function(){m_pause=false;}}var g_app;function start_app(){g_app=new App();g_app.set_canvas_and_run("main-canvas");}"use strict";function Group(sub_items){assert_new.check(this);var m_sub_items=sub_items;var m_top_left=undefined;var m_bottom_right=undefined;var m_control_points=undefined;var m_is_editing=false;var m_scale={x:1,y:1};var self=this;(function(items){var top_left_most={x:Infinity,y:Infinity};var bottom_right_most={x:-Infinity,y:-Infinity};items.forEach(function(item){var bounds_=item.bounds();top_left_most.x=Math.min(top_left_most.x,bounds_.x);top_left_most.y=Math.min(top_left_most.y,bounds_.y);var right=bounds_.x+bounds_.width;var bottom=bounds_.y+bounds_.height;bottom_right_most.x=Math.max(bottom_right_most.x,right);bottom_right_most.y=Math.max(bottom_right_most.y,bottom);});m_top_left=top_left_most;m_bottom_right=bottom_right_most;})(sub_items);var recursively_handle_items=function(items,change_points_func){if(items===undefined)return undefined;items.forEach(function(_,index){if(items[index].points!==undefined){items[index].points=change_points_func(items[index].points);}if(items[index].items!==undefined){items[index].items=recursively_handle_items(items[index].items,change_points_func);}});return items;};var on_move_control_points=function(displacement){var move_points=function(points){if(points===undefined)return undefined;points.forEach(function(_,index){points[index].x-=displacement.x;points[index].y-=displacement.y;});return points;};var move_items=function(items){return recursively_handle_items(items,move_points);};m_sub_items.forEach(function(item){item.expose(function(data){data.points=move_points(data.points);data.items=move_items(data.items);return data;});});};var on_scale_control_points=function(scale_factor,anchor_point){m_scale.x*=scale_factor.x;m_scale.y*=scale_factor.y;var handle_points=function(points){if(points===undefined)return;points.forEach(function(_,index){points[index]={x:points[index].x*scale_factor.x+anchor_point.x*(1-scale_factor.x),y:points[index].y*scale_factor.y+anchor_point.y*(1-scale_factor.y)};});return points;}var handle_items=function(items){return recursively_handle_items(items,handle_points);}self.expose(function(obj){obj.items=handle_items(obj.items);obj.points=handle_points(obj.points);return obj;});};this.highlight=function(){m_control_points=new RectangularControlPoints(m_top_left,m_bottom_right);}this.unhighlight=function(){m_control_points=undefined;}this.point_within=function(point,distance_limit){if(Vector.in_bounds(point,this.bounds()))return true;var dist=Math.min(Math.abs(m_top_left.x-point.x),Math.abs(m_top_left.y-point.y),Math.abs(m_bottom_right.x-point.x),Math.abs(m_bottom_right.y-point.y));return(dist<=distance_limit);}this.explode=function(){return m_sub_items;}this.draw=function(context){m_sub_items.forEach(function(item){item.draw(context);});if(m_control_points===undefined)return;m_control_points.draw(context);}this.bounds=function(){return{x:m_top_left.x,y:m_top_left.y,width:m_bottom_right.x-m_top_left.x,height:m_bottom_right.y-m_top_left.y};}this.handle_cursor_click=function(cursor_obj){if(!m_is_editing)return;m_control_points.handle_cursor_click(cursor_obj);}this.handle_cursor_move=function(cursor_obj){if(!m_is_editing)return;m_control_points.handle_cursor_move(cursor_obj);}this.enable_editing=function(){this.highlight();m_is_editing=true;m_control_points.set_scale_event(on_scale_control_points);m_control_points.set_move_event(on_move_control_points);}this.disable_editing=function(){this.unhighlight();m_is_editing=false;}this.expose=function(func){var gv={type:"Group",items:[]};m_sub_items.forEach(function(item){item.expose(function(as_data){gv.items.push(as_data);});});var gv_=func(gv);if(gv_!==undefined)gv=gv_;m_sub_items.forEach(function(_,index){m_sub_items[index].expose(function(_){return gv.items[index];});});}}"use strict";(function(){function find_missing_function(obj){var required_functions=["highlight","unhighlight","point_within","bounds","explode","draw","handle_cursor_move","handle_cursor_click","enable_editing","disable_editing","expose"];var rv="";required_functions.forEach(function(str){if(obj[str]===undefined){rv=str;return true;}});return rv;}function get_object_name(obj){return(/^function(.{1,})\(/).exec(obj.constructor.toString())[1];}[new Line(),new Group([]),new Polygon(),new Ellipse()].forEach(function(obj){var gv=find_missing_function(obj);if(gv!==""){throw get_object_name(obj)+" does not have a required "+"function defined: \""+gv+"\".";}});}());function Model(cursor){assert_new.check(this);var m_cursor_ref=cursor;var m_diagram_objects=[];var m_last_undone_object=undefined;var m_guidelines=[{x:1,y:0},{x:0,y:1},Vector.norm({x:3,y:1})];var m_bar_menu=new BarMenu();var m_cursor_box=undefined;var self=this;function for_each_line_in(array,func){array.forEach(function(item){if(item instanceof Line)return func(item);});}function assert_no_empties(array){array.forEach(function(item){if(item===undefined)throw"Array contains undefineds!";});}function cursor_box_size(){return{x:10,y:10};}function snap_last_object_to_guidelines(){if(m_diagram_objects.length===0)return;m_guidelines.forEach(function(guideline){var last=array_last(m_diagram_objects);if(last instanceof Line)last.snap_to_guideline(guideline,Math.PI/32);});}function delete_objects_too_small(){m_diagram_objects=array_trim(m_diagram_objects,function(object){var bounds=object.bounds();return(bounds.width<10.0&&bounds.height<10.0);});}function handle_cursor_move_on_last_if_exists(cursor){if(m_diagram_objects.length!==0)array_last(m_diagram_objects).handle_cursor_move(cursor.as_read_only());}function change_to_draw_mode(create_new_diagram_object){cursor.set_just_clicked_event(function(){if(m_bar_menu.check_click(cursor.location()))return;if(m_diagram_objects.length>0){var last_obj=array_last(m_diagram_objects);if(last_obj.finished_creating!==undefined){if(!last_obj.finished_creating())return;}}m_diagram_objects.push(create_new_diagram_object());array_last(m_diagram_objects).handle_cursor_click(cursor.as_read_only());});cursor.set_just_released_event(function(){snap_last_object_to_guidelines();handle_cursor_move_on_last_if_exists(cursor);if(m_diagram_objects.length!==0)array_last(m_diagram_objects).handle_cursor_click(cursor.as_read_only());delete_objects_too_small();});cursor.set_click_held_event(function(){if(m_diagram_objects.length!==0)array_last(m_diagram_objects).handle_cursor_move(cursor.as_read_only());snap_last_object_to_guidelines();});cursor.set_location_change_event(function(){m_cursor_box=Vector.bounds_around(cursor.location(),cursor_box_size());if(m_diagram_objects.length!==0)array_last(m_diagram_objects).handle_cursor_move(cursor.as_read_only());snap_last_object_to_guidelines();});}m_bar_menu.push_entry("Edit",function(entry){m_diagram_objects.forEach(function(object){object.enable_editing();});entry.on_mode_exit=function(){m_diagram_objects.forEach(function(object){object.disable_editing();});};cursor.set_just_clicked_event(function(){if(m_bar_menu.check_click(cursor.location()))return;m_diagram_objects.forEach(function(object){object.handle_cursor_click(cursor.as_read_only());});});cursor.set_just_released_event(function(){snap_last_object_to_guidelines();delete_objects_too_small();m_diagram_objects.forEach(function(object){object.handle_cursor_click(cursor.as_read_only());});});cursor.set_click_held_event(function(){});cursor.set_location_change_event(function(){m_cursor_box=Vector.bounds_around(cursor.location(),cursor_box_size());m_diagram_objects.forEach(function(object){object.handle_cursor_move(cursor.as_read_only());});snap_last_object_to_guidelines();});});m_bar_menu.push_entry("Draw",function(){change_to_draw_mode(function(){return new Line()});});m_bar_menu.set_last_added_entry_as_default();m_bar_menu.push_entry("Polygon",function(){change_to_draw_mode(function(){return new Polygon()});});var finish_grouping=function(){if(m_candidate_group===undefined)return;if(m_candidate_group.length===0){m_candidate_group=undefined;return;}else if(m_candidate_group.length===1){m_diagram_objects.push(m_candidate_group[0]);m_candidate_group=undefined;return;}m_candidate_group.forEach(function(item){item.unhighlight();});m_diagram_objects.push(new Group(m_candidate_group));m_candidate_group=undefined;}var m_candidate_group=undefined;var m_groups=[];var k={GROUP_DONE_TEXT:"Group Done"};Object.freeze(k);m_bar_menu.push_entry("Group",function(entry){var cursor=m_cursor_ref;m_candidate_group=[];cursor.reset_events();entry.on_mode_exit=function(entry){console.log('Left grouping mode.');if(entry.text===k.GROUP_DONE_TEXT){finish_grouping();return;}if(m_candidate_group===undefined)return;m_candidate_group.forEach(function(object){m_diagram_objects.push(object);});m_diagram_objects.forEach(function(object){object.unhighlight();});m_candidate_group=undefined;}cursor.set_just_released_event(function(){if(m_bar_menu.check_click(cursor.location()))return;var objs=m_diagram_objects;m_diagram_objects=array_trim_first(objs,function(object){if(!object.point_within(cursor.location(),10))return false;object.highlight();m_candidate_group.push(object);return true;});});cursor.set_location_change_event(function(){m_cursor_box=Vector.bounds_around(cursor.location(),cursor_box_size());});});m_bar_menu.push_entry(k.GROUP_DONE_TEXT,function(){var cursor=m_cursor_ref;cursor.reset_events();cursor.set_just_released_event(function(){if(m_bar_menu.check_click(cursor.location()))return;var ungrouped_items=[];var objs=m_diagram_objects;m_diagram_objects=array_trim_first(objs,function(object){if(!object.point_within(cursor.location(),10))return false;var gv=object.explode();if(Array.isArray(gv)){gv.forEach(function(obj){ungrouped_items.push(obj);});}else{ungrouped_items.push(gv);}return true;});assert_no_empties(ungrouped_items);ungrouped_items.forEach(function(items){m_diagram_objects.push(items);});assert_no_empties(m_diagram_objects);});cursor.set_location_change_event(function(){m_cursor_box=Vector.bounds_around(cursor.location(),cursor_box_size());});});m_bar_menu.push_entry("Undo",function(){console.log("Undo!");m_last_undone_object=array_last(m_diagram_objects);m_diagram_objects.pop();});m_bar_menu.push_entry("Save",function(){var currentdate=new Date();var datetime=currentdate.getDate()+"-"+(currentdate.getMonth()+1)+"-"+currentdate.getFullYear()+"-"+currentdate.getHours()+"-"+currentdate.getMinutes()+"-"+currentdate.getSeconds();var fileName='canvas_'+datetime.toString();var canvasElement=document.getElementById('main-canvas');var window_width=canvasElement.width;var window_height=canvasElement.height;var tempCanvas=document.createElement("canvas"),tCtx=tempCanvas.getContext("2d");tCtx.canvas.width=window_width;tCtx.canvas.height=window_height-window_height/7;var x_start=0;var y_start_org=window_height/7;var y_start_copy=0;var width=window_width;var height=window_height-window_height/7;tCtx.drawImage(canvasElement,x_start,y_start_org,width,height,x_start,y_start_copy,width,height);var MIME_TYPE="image/png";var imgURL=tempCanvas.toDataURL(MIME_TYPE);var dlLink=document.createElement('a');dlLink.download=fileName;dlLink.href=imgURL;dlLink.dataset.downloadurl=[MIME_TYPE,dlLink.download,dlLink.href].join(':');document.body.appendChild(dlLink);dlLink.click();document.body.removeChild(dlLink);});this.render_to=function(view){view.fillStyle="#000";function draw_each_of(array){array.forEach(function(item){item.draw(view);});}draw_each_of(m_diagram_objects);if(m_candidate_group!==undefined){draw_each_of(m_candidate_group);}m_bar_menu.draw(view);if(m_cursor_box!==undefined){view.fillRect(m_cursor_box.x,m_cursor_box.y,m_cursor_box.width,m_cursor_box.height);}}}"use strict";var assert_new={global_this:this,check:function(this_){if(this_===this.global_this)throw"You must use \"new\" to create new objects.";}};Object.freeze(assert_new);function assert_not_nan(f){if(f!=f)throw"Nan!";}function array_last(arr){return arr[arr.length-1];}function set_array_last(arr,item){arr[arr.length-1]=item;return arr;}function array_clean(arr){var rv=[];arr.forEach(function(entry){if(entry)rv.push(entry);});return rv;};function array_trim(arr,condition){var modify_array=function(arr){return arr};for(var i=0;i<arr.length;++i){if(condition(arr[i])){delete arr[i];modify_array=array_clean;}}return modify_array(arr);}function array_trim_first(arr,condition){var modify_array=function(arr){return arr};for(var i=0;i<arr.length;++i){if(condition(arr[i])){delete arr[i];modify_array=array_clean;break;}}return modify_array(arr);}var Vector={mag:function(v){return Math.sqrt(v.x*v.x+v.y*v.y);},angle_between:function(u,v){var dot_prod=u.x*v.x+u.y*v.y;return Math.acos(dot_prod/(this.mag(u)*this.mag(v)));},to_string:function(v){return"(x: "+v.x+" y: "+v.y+" )";},norm:function(v){return{x:v.x/this.mag(v),y:v.y/this.mag(v)};},add:function(v,u){return{x:v.x+u.x,y:v.y+u.y};},sub:function(v,u){return{x:v.x-u.x,y:v.y-u.y};},in_bounds:function(v,bounds){return v.x>bounds.x&&v.x<bounds.x+bounds.width&&v.y>bounds.y&&v.y<bounds.y+bounds.height;},bounds_around:function(point,size_vect){return{x:point.x-size_vect.x/2,y:point.y-size_vect.y/2,width:size_vect.x,height:size_vect.y};},distance:function(u,v){return this.mag(this.sub(u,v));}}Object.freeze(Vector);var g_this=this;function zero_vect(){return{x:0,y:0};}function deepcopy(obj){if($.isArray(obj)){return $.extend(true,[],obj);}else{return $.extend(true,{},obj);}}function draw_bounds_as_black_outlined_box(context,cp_bounds,fill_color){context.beginPath();context.rect(cp_bounds.x,cp_bounds.y,cp_bounds.width,cp_bounds.height);context.fillStyle=fill_color;context.fill();context.lineWidth=1;context.strokeStyle='black';context.stroke();}"use strict";function RectangularControlPoints(top_left,bottom_right){assert_new.check(this);var k=Object.freeze({TOP_LEFT:0,TOP_RIGHT:1,BOTTOM_RIGHT:2,BOTTOM_LEFT:3});var m_bounds_points=[undefined,undefined,undefined,undefined];var m_move_point=undefined;var m_on_scale=function(_){};var m_on_move=function(_){};var m_is_being_dragged=false;var self=this;(function(){var pts=m_bounds_points;pts[k.TOP_LEFT]=top_left;pts[k.TOP_RIGHT]={x:bottom_right.x,y:top_left.y};pts[k.BOTTOM_RIGHT]=bottom_right;pts[k.BOTTOM_LEFT]={x:top_left.x,y:bottom_right.y};})();function point_size(){return 10.0;}function bounds_around(point){return Vector.bounds_around(point,{x:point_size(),y:point_size()});}function draw_bounds(context,cp_bounds,fill_color){draw_bounds_as_black_outlined_box(context,cp_bounds,fill_color);}function cursor_in_pt(cursor_obj,point){return Vector.in_bounds(cursor_obj.location(),bounds_around(point));}function prev_index(idx){if(idx===0){return m_bounds_points.length-1;}else{return idx-1;}}function next_index(idx){return(idx+1)%m_bounds_points.length;}function update_center_point_location(){var top_left=m_bounds_points[k.TOP_LEFT];var bottom_right=m_bounds_points[k.BOTTOM_RIGHT];m_move_point={x:(top_left.x+bottom_right.x)/2,y:(top_left.y+bottom_right.y)/2};}update_center_point_location();function drag_end_point(cursor_obj,index){var cur_loc=cursor_obj.location();var old_bounds=self.bounds();if(index%2===0){m_bounds_points[prev_index(index)].x=cur_loc.x;m_bounds_points[next_index(index)].y=cur_loc.y;}else{m_bounds_points[next_index(index)].x=cur_loc.x;m_bounds_points[prev_index(index)].y=cur_loc.y;}m_bounds_points[index]=cur_loc;var new_bounds=self.bounds();if(new_bounds.x!==old_bounds.x||new_bounds.y!==old_bounds.y){m_on_move(Vector.sub(old_bounds,new_bounds));}m_on_scale({x:new_bounds.width/old_bounds.width,y:new_bounds.height/old_bounds.height},m_bounds_points[index]);update_center_point_location();}function drag_center_point(cursor_obj){var displacement=Vector.sub(m_move_point,cursor_obj.location());m_move_point=cursor_obj.location();m_bounds_points.forEach(function(_,index){m_bounds_points[index].x-=displacement.x;m_bounds_points[index].y-=displacement.y;});m_on_move(displacement);}this.handle_cursor_click=function(cursor_obj){if(!cursor_obj.is_pressed()){m_is_being_dragged=false;self.handle_cursor_move=function(_){};return;}m_bounds_points.forEach(function(pt,index){if(!cursor_in_pt(cursor_obj,pt))return;m_is_being_dragged=true;self.handle_cursor_move=function(cursor_obj){drag_end_point(cursor_obj,index);}return true;});if(cursor_in_pt(cursor_obj,m_move_point)){m_is_being_dragged=true;self.handle_cursor_move=drag_center_point;}}this.handle_cursor_move=function(_){};this.bounds=function(){var bottom_right_=m_bounds_points[k.BOTTOM_RIGHT];return{x:m_bounds_points[k.TOP_LEFT].x,y:m_bounds_points[k.TOP_LEFT].y,width:bottom_right_.x-m_bounds_points[k.TOP_LEFT].x,height:bottom_right_.y-m_bounds_points[k.TOP_LEFT].y};}this.draw=function(context){m_bounds_points.forEach(function(bounds_point){draw_bounds(context,bounds_around(bounds_point),'yellow');});draw_bounds(context,bounds_around(m_move_point),'blue');}this.set_scale_event=function(func){m_on_scale=func;}this.set_move_event=function(func){m_on_move=func;}}"use strict";function BarMenu(){assert_new.check(this);var m_entries=[];var m_previous_press=undefined;var m_location=zero_vect();var m_size=zero_vect();var self=this;var handle_click_inside=function(entry){if(m_previous_press!==entry){if(m_previous_press!==undefined)m_previous_press.on_mode_exit(entry,m_previous_press);entry.callback(entry);}m_previous_press=entry;}this.push_entry=function(text_,callback_){m_entries.push({text:text_,callback:callback_,on_mode_exit:function(_){}});return self;}this.set_last_added_entry_as_default=function(){if(m_previous_press!==undefined){throw"Already set default menu entry!";}array_last(m_entries).callback(array_last(m_entries));m_previous_press=array_last(m_entries);}this.check_click=function(cursor){if(m_entries.length===0)return false;if(m_entries[0].bounds===undefined)return false;var rv=false;m_entries.forEach(function(entry){if(Vector.in_bounds(cursor,entry.bounds)){handle_click_inside(entry);rv=true;return true;}});return rv;}this.draw=function(context){var draw_position=deepcopy(m_location);var window_width=$(window).width();var window_height=$(window).height();m_size=zero_vect();context.font=(window_height/22)+"px Arial";context.lineWidth=1;context.strokeStyle='black';m_entries.forEach(function(entry){var entry_size={x:window_width/m_entries.length,y:parseInt(context.font)+window_height/12};entry.bounds={x:draw_position.x,y:draw_position.y,width:entry_size.x,height:entry_size.y};context.beginPath();if(m_previous_press===entry){context.fillStyle='yellow';}else{context.fillStyle='white';}context.fillRect(draw_position.x,draw_position.y,entry_size.x,entry_size.y);context.rect(draw_position.x,draw_position.y,entry_size.x,entry_size.y);context.stroke();context.fillStyle='black';var text_width=context.measureText(entry.text).width;var box_width=window_width/m_entries.length;var position=(box_width-text_width)/2;context.fillText(entry.text,draw_position.x+position,draw_position.y+entry_size.y/2);m_size.x+=entry_size.x;draw_position.x+=entry_size.x;});}}"use strict";var LineConstants={POINT_A_STRING:'a',POINT_B_STRING:'b',BOTH_POINTS:'both'};Object.freeze(LineConstants);function LineControlPoints(point_a,point_b){assert_new.check(this);var m_move_point_a=undefined;var m_move_point_b=undefined;var m_move_whole_line=undefined;var m_update_control_point_func=undefined;this.draw=function(context){draw_point_bounds(context,m_move_point_a,'yellow');draw_point_bounds(context,m_move_point_b,'yellow');draw_point_bounds(context,m_move_whole_line,'blue');}this.handle_cursor_move=function(cursor_pos){if(m_update_control_point_func===undefined)return{};return m_update_control_point_func(cursor_pos);}this.handle_cursor_click=function(cursor_pos,pressed){if(!pressed){m_update_control_point_func=undefined;return'';}if(Vector.in_bounds(cursor_pos,m_move_point_a)){m_update_control_point_func=update_point_a;return LineConstants.POINT_A_STRING;}if(Vector.in_bounds(cursor_pos,m_move_point_b)){m_update_control_point_func=update_point_b;return LineConstants.POINT_B_STRING;}if(Vector.in_bounds(cursor_pos,m_move_whole_line)){m_update_control_point_func=update_both_points;return LineConstants.BOTH_POINTS;}return'';}this.is_editing_point_a=function(){return m_update_control_point_func===update_point_a;}this.is_editing_point_b=function(){return m_update_control_point_func===update_point_b;}this.set_points=function(point_a,point_b){m_move_point_a=bounds_around(point_a);m_move_point_b=bounds_around(point_b);m_move_whole_line=bounds_around(avg_vect(point_a,point_b));}this.set_points(point_a,point_b);function point_size(){return 10.0;}function bounds_around(point){return Vector.bounds_around(point,{x:point_size(),y:point_size()});}function avg_vect(u,v){return{x:(u.x+v.x)/2,y:(u.y+v.y)/2};}function draw_point_bounds(context,cp_bounds,fill_color){draw_bounds_as_black_outlined_box(context,cp_bounds,fill_color);}var update_point_a=function(cursor_pos){m_move_point_a=bounds_around(cursor_pos);m_move_whole_line=bounds_around(avg_vect(cursor_pos,m_move_point_b));return{a:cursor_pos};};var update_point_b=function(cursor_pos){m_move_point_b=bounds_around(cursor_pos);m_move_whole_line=bounds_around(avg_vect(m_move_point_a,cursor_pos));return{b:cursor_pos};};var update_both_points=function(cursor_pos){var center_of=function(bounds){return{x:bounds.x+bounds.width/2,y:bounds.y+bounds.height/2};};var cent=center_of(m_move_whole_line);var to_a=Vector.sub(center_of(m_move_point_a),cent);var to_b=Vector.sub(center_of(m_move_point_b),cent);m_move_whole_line=bounds_around(cursor_pos);var resp={a:Vector.add(cursor_pos,to_a),b:Vector.add(cursor_pos,to_b)};m_move_point_a=bounds_around(resp.a);m_move_point_b=bounds_around(resp.b);return resp;};}function Line(){assert_new.check(this);var m_point_a=zero_vect();var m_point_b=zero_vect();var m_control_points=undefined;var m_handle_cursor_move_func=undefined;var m_handle_cursor_click_func=undefined;var handle_cursor_move_editing=function(cursor_obj){var cursor_pos=cursor_obj.location();var gv=m_control_points.handle_cursor_move(cursor_pos);var rv=false;if(gv.a!==undefined){m_point_a=gv.a;rv=true;}if(gv.b!==undefined){m_point_b=gv.b;rv=true;}return rv;};var handle_cursor_click_editing=function(cursor_obj){var cursor_pos=cursor_obj.location(),pressed=cursor_obj.is_pressed();return m_control_points.handle_cursor_click(cursor_pos,pressed);};m_handle_cursor_click_func=function(cursor_obj){if(cursor_obj.is_pressed()){m_point_b=m_point_a=cursor_obj.location();}else{m_handle_cursor_click_func=m_handle_cursor_move_func=function(o){};}};m_handle_cursor_move_func=function(cursor_obj){m_point_b=cursor_obj.location();};this.enable_editing=function(){this.highlight();m_handle_cursor_move_func=handle_cursor_move_editing;m_handle_cursor_click_func=handle_cursor_click_editing;}this.disable_editing=function(){m_control_points=undefined;m_handle_cursor_move_func=function(c){};m_handle_cursor_click_func=function(c,p){return'';};}this.highlight=function(){m_control_points=new LineControlPoints(m_point_a,m_point_b);}this.unhighlight=function(){m_control_points=undefined;}this.explode=function(){return this;}this.handle_cursor_click=function(cursor_pos,pressed){return m_handle_cursor_click_func(cursor_pos,pressed);}this.handle_cursor_move=function(cursor_pos,pressed){m_handle_cursor_move_func(cursor_pos);}this.point_within=function(point,distance_limit){if(distance_limit===undefined)throw"distance_limit must be defined";var a=m_point_a;var b=m_point_b;var c=point;var xs_diff_sq=(a.x-b.x)*(a.x-b.x);var ys_diff_sq=(a.y-b.y)*(a.y-b.y);if(xs_diff_sq===0&&ys_diff_sq===0)return Vector.distance(c,a)<=distance_limit;var dist=Math.abs((b.y-a.y)*c.x-(b.x-a.x)*c.y+b.x*a.y-b.y*a.x)/Math.sqrt(xs_diff_sq+ys_diff_sq);return(dist<=distance_limit);}this.snap_to_guideline=function(guide_line,rads){var diff={x:m_point_a.x-m_point_b.x,y:m_point_a.y-m_point_b.y};var error_con=0.005;var ang_bet=Vector.angle_between(diff,guide_line);var scalar=0;var angle_diff=Math.abs(rads-ang_bet);if(angle_diff>error_con&&angle_diff<rads)scalar=1;angle_diff=Math.abs(Math.PI-rads-ang_bet);if(angle_diff>error_con&&angle_diff<rads)scalar=-1;if(scalar===0){return false;}var saved_mag=Vector.mag(diff);var to_other_point={x:saved_mag*scalar*guide_line.x,y:saved_mag*scalar*guide_line.y};var comp_new_pt_b=function(){return{x:-to_other_point.x+m_point_a.x,y:-to_other_point.y+m_point_a.y};};if(m_control_points===undefined){m_point_b=comp_new_pt_b();}else{if(m_control_points.is_editing_point_a()){m_point_a={x:to_other_point.x+m_point_b.x,y:to_other_point.y+m_point_b.y};}else if(m_control_points.is_editing_point_b()){m_point_b=comp_new_pt_b();}else{}m_control_points.set_points(m_point_a,m_point_b);}return true;}this.draw=function(context){context.beginPath();context.moveTo(m_point_a.x,m_point_a.y);context.lineTo(m_point_b.x,m_point_b.y);context.lineWidth=5;context.stroke();if(m_control_points!==undefined)m_control_points.draw(context);}this.bounds=function(){var x_=Math.min(m_point_a.x,m_point_b.x);var y_=Math.min(m_point_a.y,m_point_b.y);return{x:x_,y:y_,width:Math.abs(m_point_a.x-m_point_b.x),height:Math.abs(m_point_a.y-m_point_b.y)};}this.expose=function(func){var gv=func({type:"Line",points:[m_point_a,m_point_b]});if(gv===undefined)return;m_point_a=gv.points[0];m_point_b=gv.points[1];if(m_control_points!==undefined)m_control_points.set_points(gv.a,gv.b);}}"use strict";function Controller(){assert_new.check(this);var m_min_speed=200;var m_max_dbl_click_delay=0.1;var m_cursor_location=zero_vect();var m_cursor_direction=zero_vect();var m_cursor_velocity=zero_vect();var m_time_since_previous_click=0;var m_click_was_held=false;var m_click_held=false;var m_location_change_event=undefined;var m_just_clicked_event=undefined;var m_just_released_event=undefined;var m_click_held_event=undefined;var m_double_click_event=undefined;var throw_if_param_not_func=function(func){if(!$.isFunction(func))throw"func parameter must be a function";}this.location=function(){return m_cursor_location;}this.is_pressed=function(){return m_click_held;}this.as_read_only=function(){return new function(loc_,is_pres_){var loc=loc_;var is_pres=is_pres_;this.location=function(){return loc;}this.is_pressed=function(){return is_pres;}}(this.location(),this.is_pressed());}this.set_location=function(v){m_cursor_location=v;if(m_location_change_event!==undefined)m_location_change_event();}this.move_in_direction=function(dir){m_cursor_direction=dir;}this.set_pressed=function(pressed){m_click_was_held=m_click_held;m_click_held=pressed;if(m_click_held&&m_click_was_held){m_click_held_event();}else if(m_click_held&&!m_click_was_held){m_just_clicked_event();}else if(!m_click_held&&m_click_was_held){m_just_released_event();}}this.do_time_based_updates=function(et){var mul=function(s,v){return{x:s*v.x,y:s*v.y};};var add=Vector.add;var mag=Vector.mag;var norm=Vector.norm;if(mag(m_cursor_direction)!==0){m_cursor_location=add(m_cursor_location,mul(m_min_speed*et,m_cursor_direction));m_cursor_direction=zero_vect();m_location_change_event();}if(m_click_held&&m_click_was_held)m_click_held_event();}this.reset_events=function(){m_location_change_event=function(){};m_just_clicked_event=function(){};m_just_released_event=function(){};m_click_held_event=function(){};m_double_click_event=function(){};}this.reset_events();this.set_location_change_event=function(func){throw_if_param_not_func(func);m_location_change_event=func;}this.set_just_clicked_event=function(func){throw_if_param_not_func(func);m_just_clicked_event=func;}this.set_click_held_event=function(func){throw_if_param_not_func(func);m_click_held_event=func;}this.set_just_released_event=function(func){throw_if_param_not_func(func);m_just_released_event=func;}this.set_double_click_event=function(func){throw_if_param_not_func(func);m_double_click_event=func;}}"use strict";function Draggable(){assert_new.check(this);var m_is_being_dragged=false;var within_point=function(parent_point,cursor_point){return Vector.mag(Vector.sub(parent_point,cursor_point))<10.0;}this.is_being_dragged=function(){return m_is_being_dragged;}this.handle_draggable_cursor_click=function(cursor_obj,this_location){if(within_point(this_location,cursor_obj.location())&&cursor_obj.is_pressed()){m_is_being_dragged=true;}else if(!cursor_obj.is_pressed()&&m_is_being_dragged){m_is_being_dragged=false;}}}function PolygonTranslationControlPoint(){assert_new.check(this);Draggable.call(this);var m_location=undefined;var m_old_location=undefined;var self=this;this.set_location=function(array_of_points){var v={x:0,y:0};var count=0;array_of_points.forEach(function(point){v.x+=point.x;v.y+=point.y;++count;});v.x/=count;v.y/=count;m_old_location=m_location=v;}this.handle_cursor_click=function(cursor_obj){self.handle_draggable_cursor_click(cursor_obj,m_location);}this.handle_cursor_move=function(cursor_obj,polygon_points){if(!self.is_being_dragged())return;if(m_old_location===undefined)throw"set_location must be called before move events are handled";var displacement=Vector.sub(m_location,m_old_location);m_old_location=m_location;m_location=cursor_obj.location();polygon_points.forEach(function(_,index,array){array[index]=Vector.add(array[index],displacement);});}this.draw=function(context){draw_bounds_as_black_outlined_box(context,Vector.bounds_around(m_location,{x:10,y:10}),'blue');}}PolygonTranslationControlPoint.prototype=Object.create(Draggable.prototype);PolygonTranslationControlPoint.prototype.constructor=PolygonTranslationControlPoint;function PolygonEndControlPoint(){assert_new.check(this);Draggable.call(this);var m_parent_point=undefined;var m_parent_index=undefined;var self=this;self.handle_cursor_click=function(cursor_obj){self.handle_draggable_cursor_click(cursor_obj,m_parent_point);}self.handle_cursor_move=function(cursor_obj,polygon_points){if(self.is_being_dragged()){m_parent_point=cursor_obj.location();polygon_points[m_parent_index]=m_parent_point;}else if(cursor_obj.is_pressed()){m_parent_point=polygon_points[m_parent_index];}}self.set_parent_point=function(point,index){m_parent_point=point;m_parent_index=index;}self.location=function(){return m_parent_point;}self.draw=function(context){if(m_parent_point===undefined)return;draw_bounds_as_black_outlined_box(context,Vector.bounds_around(m_parent_point,{x:10,y:10}),'yellow');}}PolygonEndControlPoint.prototype=Object.create(Draggable.prototype);PolygonEndControlPoint.prototype.constructor=PolygonEndControlPoint;function Polygon(){assert_new.check(this);var m_points=[];var m_bounds=undefined;var m_candidate_point=undefined;var m_control_points=[];var self=this;var draw_line_from_index=function(context,index){var next_index=(index+1)%m_points.length;draw_line(context,m_points[index],m_points[next_index]);}var draw_line=function(context,point_a,point_b){context.beginPath();context.moveTo(point_a.x,point_a.y);context.lineTo(point_b.x,point_b.y);context.lineWidth=5;context.stroke();}var within_first_point=function(cursor_loc){if(m_points.length===0)return false;return Math.abs(m_points[0].x-cursor_loc.x)<10.0&&Math.abs(m_points[0].y-cursor_loc.y)<10.0;}var update_bounds=function(){if(m_points.length===0)return{x:0,y:0,width:0,height:0};var min_x=Infinity,min_y=Infinity,max_x=0,max_y=0;m_points.forEach(function(pt){min_x=Math.min(min_x,pt.x);min_y=Math.min(min_y,pt.y);max_x=Math.max(max_x,pt.x);max_y=Math.max(max_y,pt.y);});return m_bounds={x:min_x,y:min_y,width:max_x-min_x,height:max_y-min_y};}var handle_cursor_click_creation=function(cursor_obj){if(m_points.length===0&&cursor_obj.is_pressed()){m_points.push(cursor_obj.location());return;}if(!cursor_obj.is_pressed()){if(within_first_point(cursor_obj.location())){self.handle_cursor_click=self.handle_cursor_move=function(_){};self.draw=draw_while_editing_or_viewing;update_bounds();return;}m_points.push(cursor_obj.location());}}var handle_cursor_move_creation=function(cursor_obj){if(m_points.length>0){m_candidate_point=cursor_obj.location();}}var draw_while_creating=function(context){var save_restore=function(context,func){context.save();func();context.restore();};for(var i=0;i!==m_points.length-1;++i)draw_line_from_index(context,i);if(m_points.length!==0&&m_candidate_point!==undefined){draw_line(context,array_last(m_points),m_candidate_point);draw_line(context,m_candidate_point,m_points[0]);}if(m_points.length!==0){var radius=5;var pt=m_points[0];save_restore(context,function(){context.beginPath();context.arc(pt.x-radius,pt.y-radius,radius,0,2*Math.PI,false);context.font='12pt Verdana';context.fillText("Click here to finish drawing.",pt.x,pt.y);context.lineWidth=3;context.strokeStyle='red';context.stroke();});}}var check_point_merging=function(index){var cpt=m_control_points[index].location();var check_neighbor_for_merge=function(offset){var np=m_control_points[index+offset].location();if(Vector.mag(Vector.sub(np,cpt))<10){m_control_points.splice(index,1);m_points.splice(index,1);console.log('spliced polygon'+m_points.length);}};if(index>0)check_neighbor_for_merge(-1);if(index<m_points.length-1)check_neighbor_for_merge(1);}var handle_cursor_click_editing=function(cursor_obj){m_control_points.forEach(function(control_point){control_point.handle_cursor_click(cursor_obj);});array_last(m_control_points).set_location(m_points);};var handle_cursor_move_editing=function(cursor_obj){m_control_points.forEach(function(control_point,index){var was_dragged=control_point.is_being_dragged();control_point.handle_cursor_move(cursor_obj,m_points);if(was_dragged&&!control_point.is_being_dragged()){check_point_merging(index);}});}var draw_while_editing_or_viewing=function(context){for(var i=0;i!==m_points.length;++i)draw_line_from_index(context,i);m_control_points.forEach(function(control_point){control_point.draw(context);});};this.handle_cursor_click=handle_cursor_click_creation;this.handle_cursor_move=handle_cursor_move_creation;this.draw=draw_while_creating;this.finished_creating=function(){return self.draw===draw_while_editing_or_viewing;}this.enable_editing=function(){self.highlight();m_control_points.push(new PolygonTranslationControlPoint());array_last(m_control_points).set_location(m_points);self.handle_cursor_click=handle_cursor_click_editing;self.handle_cursor_move=handle_cursor_move_editing;}this.disable_editing=function(){m_control_points=[];self.handle_cursor_move=self.handle_cursor_click=function(_){};}this.bounds=function(){return m_bounds;}this.point_within=function(cursor_loc,size){return Vector.in_bounds(cursor_loc,self.bounds());}this.highlight=function(){m_points.forEach(function(point,index,array){m_control_points.push(new PolygonEndControlPoint());array_last(m_control_points).set_parent_point(array[index],index);});}this.unhighlight=function(){m_control_points=[];}this.explode=function(){return this;}this.expose=function(func){var gv=func({type:"Polygon",points:deepcopy(m_points)});if(gv===undefined)return;m_points=gv.points;if(m_control_points===undefined)return;this.disable_editing();this.enable_editing();}}"use strict";function Ellipse(){assert_new.check(this);var m_radii=zero_vect();var m_location=zero_vect();var m_first_point=undefined;var m_finished_creating=false;var self=this;this.set_location=function(x_,y_){m_location={x:x_,y:y_};}this.set_radii=function(x_,y_){m_radii={x:x_,y:y_};}this.finished_creating=function(){return m_finished_creating;}this.highlight=function(){}this.unhighlight=function(){}this.enable_editing=function(){}this.disable_editing=function(){}this.point_within=undefined;this.explode=function(){return this;}this.bounds=function(){return{x:m_location.x-m_radii.x,y:m_location.y-m_radii.y,width:m_radii.x*2.0,height:m_radii.y*2.0}}var creation_second_handle_cursor_click=function(cursor_obj){if(cursor_obj.is_pressed())return;console.log('moving to final step...')m_first_point=cursor_obj.location();self.handle_cursor_move=function(cursor_obj){var cur_loc=cursor_obj.location();var num=cur_loc.x**2*m_first_point.y**2-cur_loc.y**2*m_first_point.x**2;m_radii.x=Math.sqrt(Math.abs(num/(cur_loc.x**2-m_first_point.x**2)));m_radii.y=Math.sqrt(Math.abs(num/(cur_loc.y**2-m_first_point.y**2)));if(Math.random()>0.95){console.log("radii values : (x: "+m_radii.x+", y: "+m_radii.y+")");}}self.handle_cursor_click=function(cursor_obj){if(!cursor_obj.is_pressed()){m_finished_creating=true;self.handle_cursor_click=self.handle_cursor_move=function(_){}}}}this.handle_cursor_click=function(cursor_obj){if(cursor_obj.is_pressed()){m_location=cursor_obj.location();console.log("ellipse location set");return;}console.log("cursor move event function changed");self.handle_cursor_move=function(cursor_obj){m_radii.x=m_radii.y=Vector.distance(cursor_obj.location(),m_location);}self.handle_cursor_click=creation_second_handle_cursor_click;}this.handle_cursor_move=function(_){}this.draw=function(context){context.save();context.translate(m_location.x,m_location.y);context.scale(m_radii.x,m_radii.y);context.beginPath();context.arc(0,0,1,0,2*Math.PI,false);context.restore();context.fillStyle='black';context.fill();context.lineWidth=3;context.strokeStyle='black';context.stroke();if(m_first_point!==undefined){var fp_bounds=Vector.bounds_around(m_first_point,{x:10,y:10});draw_bounds_as_black_outlined_box(context,fp_bounds,'black');}}}
